import{r as e}from"./rope-sequence.7d68748c.js";import{M as t}from"./prosemirror-transform.de62111a.js";import{P as n,a as r}from"./prosemirror-state.1b80bdaa.js";var s=function(e,t){this.items=e,this.eventCount=t};s.prototype.popEvent=function(e,t){var n=this;if(0==this.eventCount)return null;for(var r,a,o=this.items.length;;o--){if(this.items.get(o-1).selection){--o;break}}t&&(r=this.remapping(o,this.items.length),a=r.maps.length);var p,u,m=e.tr,l=[],h=[];return this.items.forEach((function(e,t){if(!e.step)return r||(r=n.remapping(o,t+1),a=r.maps.length),a--,void h.push(e);if(r){h.push(new i(e.map));var f,c=e.step.map(r.slice(a));c&&m.maybeStep(c).doc&&(f=m.mapping.maps[m.mapping.maps.length-1],l.push(new i(f,null,null,l.length+h.length))),a--,f&&r.appendMap(f,a)}else m.maybeStep(e.step);return e.selection?(p=r?e.selection.map(r.slice(a)):e.selection,u=new s(n.items.slice(0,o).append(h.reverse().concat(l)),n.eventCount-1),!1):void 0}),this.items.length,0),{remaining:u,transform:m,selection:p}},s.prototype.addTransform=function(e,t,n,r){for(var a=[],p=this.eventCount,u=this.items,m=!r&&u.length?u.get(u.length-1):null,l=0;l<e.steps.length;l++){var h,f=e.steps[l].invert(e.docs[l]),c=new i(e.mapping.maps[l],f,t);(h=m&&m.merge(c))&&(c=h,l?a.pop():u=u.slice(0,u.length-1)),a.push(c),t&&(p++,t=null),r||(m=c)}var g,v,d,w=p-n.depth;return w>o&&(v=w,(g=u).forEach((function(e,t){if(e.selection&&0==v--)return d=t,!1})),u=g.slice(d),p-=w),new s(u.append(a),p)},s.prototype.remapping=function(e,n){var r=new t;return this.items.forEach((function(t,n){var s=null!=t.mirrorOffset&&n-t.mirrorOffset>=e?r.maps.length-t.mirrorOffset:null;r.appendMap(t.map,s)}),e,n),r},s.prototype.addMaps=function(e){return 0==this.eventCount?this:new s(this.items.append(e.map((function(e){return new i(e)}))),this.eventCount)},s.prototype.rebased=function(e,t){if(!this.eventCount)return this;var n=[],r=Math.max(0,this.items.length-t),a=e.mapping,o=e.steps.length,p=this.eventCount;this.items.forEach((function(e){e.selection&&p--}),r);var u=t;this.items.forEach((function(t){var r=a.getMirror(--u);if(null!=r){o=Math.min(o,r);var s=a.maps[r];if(t.step){var m=e.steps[r].invert(e.docs[r]),l=t.selection&&t.selection.map(a.slice(u+1,r));l&&p++,n.push(new i(s,m,l))}else n.push(new i(s))}}),r);for(var m=[],l=t;l<o;l++)m.push(new i(a.maps[l]));var h=this.items.slice(0,r).append(m).append(n),f=new s(h,p);return f.emptyItemCount()>500&&(f=f.compress(this.items.length-n.length)),f},s.prototype.emptyItemCount=function(){var e=0;return this.items.forEach((function(t){t.step||e++})),e},s.prototype.compress=function(t){void 0===t&&(t=this.items.length);var n=this.remapping(0,t),r=n.maps.length,a=[],o=0;return this.items.forEach((function(e,s){if(s>=t)a.push(e),e.selection&&o++;else if(e.step){var p=e.step.map(n.slice(r)),u=p&&p.getMap();if(r--,u&&n.appendMap(u,r),p){var m=e.selection&&e.selection.map(n.slice(r));m&&o++;var l,h=new i(u.invert(),p,m),f=a.length-1;(l=a.length&&a[f].merge(h))?a[f]=l:a.push(h)}}else e.map&&r--}),this.items.length,0),new s(e.from(a.reverse()),o)},s.empty=new s(e.empty,0);var i=function(e,t,n,r){this.map=e,this.step=t,this.selection=n,this.mirrorOffset=r};i.prototype.merge=function(e){if(this.step&&e.step&&!e.selection){var t=e.step.merge(this.step);if(t)return new i(t.getMap().invert(),t,this.selection)}};var a=function(e,t,n,r){this.done=e,this.undone=t,this.prevRanges=n,this.prevTime=r},o=20;function p(e){var t=[];return e.forEach((function(e,n,r,s){return t.push(r,s)})),t}function u(e,t){if(!e)return null;for(var n=[],r=0;r<e.length;r+=2){var s=t.map(e[r],1),i=t.map(e[r+1],-1);s<=i&&n.push(s,i)}return n}function m(e,t,n,r){var s=f(t),i=c.get(t).spec.config,o=(r?e.undone:e.done).popEvent(t,s);if(o){var p=o.selection.resolve(o.transform.doc),u=(r?e.done:e.undone).addTransform(o.transform,t.selection.getBookmark(),i,s),m=new a(r?u:o.remaining,r?o.remaining:u,null,0);n(o.transform.setSelection(p).setMeta(c,{redo:r,historyState:m}).scrollIntoView())}}var l=!1,h=null;function f(e){var t=e.plugins;if(h!=t){l=!1,h=t;for(var n=0;n<t.length;n++)if(t[n].spec.historyPreserveItems){l=!0;break}}return l}var c=new n("history"),g=new n("closeHistory");function v(e){return e={depth:e&&e.depth||100,newGroupDelay:e&&e.newGroupDelay||500},new r({key:c,state:{init:function(){return new a(s.empty,s.empty,null,0)},apply:function(t,n,r){return function(e,t,n,r){var i,o=n.getMeta(c);if(o)return o.historyState;n.getMeta(g)&&(e=new a(e.done,e.undone,null,0));var m=n.getMeta("appendedTransaction");if(0==n.steps.length)return e;if(m&&m.getMeta(c))return m.getMeta(c).redo?new a(e.done.addTransform(n,null,r,f(t)),e.undone,p(n.mapping.maps[n.steps.length-1]),e.prevTime):new a(e.done,e.undone.addTransform(n,null,r,f(t)),null,e.prevTime);if(!1===n.getMeta("addToHistory")||m&&!1===m.getMeta("addToHistory"))return(i=n.getMeta("rebased"))?new a(e.done.rebased(n,i),e.undone.rebased(n,i),u(e.prevRanges,n.mapping),e.prevTime):new a(e.done.addMaps(n.mapping.maps),e.undone.addMaps(n.mapping.maps),u(e.prevRanges,n.mapping),e.prevTime);var l=0==e.prevTime||!m&&(e.prevTime<(n.time||0)-r.newGroupDelay||!function(e,t){if(!t)return!1;if(!e.docChanged)return!0;var n=!1;return e.mapping.maps[0].forEach((function(e,r){for(var s=0;s<t.length;s+=2)e<=t[s+1]&&r>=t[s]&&(n=!0)})),n}(n,e.prevRanges)),h=m?u(e.prevRanges,n.mapping):p(n.mapping.maps[n.steps.length-1]);return new a(e.done.addTransform(n,l?t.selection.getBookmark():null,r,f(t)),s.empty,h,n.time)}(n,r,t,e)}},config:e})}function d(e,t){var n=c.getState(e);return!(!n||0==n.done.eventCount)&&(t&&m(n,e,t,!1),!0)}function w(e,t){var n=c.getState(e);return!(!n||0==n.undone.eventCount)&&(t&&m(n,e,t,!0),!0)}function y(e){var t=c.getState(e);return t?t.done.eventCount:0}export{y as a,v as h,w as r,d as u};
